<html>
	<head>
		<title>Лепро-ТВ</title>
        <link href='/style.css' rel='stylesheet' type='text/css'>
	</head>
	<body>

        <content><login-form>
                <input id="username" type="text" placeholder="%username%"></input>
                <input id="password" type="password" placeholder="%password%"></input>
                <button id="login">Проникнуть</button>
            </login-form></content>

        <script>

            var contentEl = document.querySelector ('content')

            var server = (window.location.hash === '#dirty') ? 'dirty' : 'leprosorium'

            var futuwareAuth = null

            function apiRequest (verb, path, data) {

                return new Promise (function (resolve, reject) {

                    var xhr = new XMLHttpRequest ()
                       
                    xhr.open (verb, 'https://' + server + '.ru/api/' + path, true)

                    if (futuwareAuth) {
                        xhr.setRequestHeader ('X-Futuware-SID', futuwareAuth.sid)
                        xhr.setRequestHeader ('X-Futuware-UID', futuwareAuth.uid)
                    }

                    xhr.onload = function () {

                        if (xhr.status === 200) { resolve (JSON.parse (xhr.responseText)) }
                                           else { reject  (xhr.status) }
                    }

                    xhr.onerror = function (e) {

                        reject (403)
                    }

                    if (data) {
                        xhr.setRequestHeader ('Content-Type', 'application/json')
                        xhr.send (JSON.stringify (data))
                    } else {
                        xhr.send ()
                    }
                })
            }

            function penetrate () {

                var username = document.querySelector ('#username').value = localStorage.getItem ('username') || ''
                var password = document.querySelector ('#password').value = localStorage.getItem ('password') || ''

                return new Promise (function (resolve) {

                    var tryLogin = function () {

                        localStorage.setItem ('username', username = document.querySelector ('#username').value)
                        localStorage.setItem ('password', password = document.querySelector ('#password').value)

                        contentEl.setAttribute ('loading', true)

                        apiRequest ('POST', 'auth/login/', { username: username, password: password })

                            .then (function (response) {
                                futuwareAuth = response
                                contentEl.removeChild (document.querySelector ('login-form'))
                                resolve ()
                            })
                            .catch (function (e) {
                                contentEl.removeAttribute ('loading')
                                alert ('проблемы с логином: ' + e)
                            })
                    }

                    document.querySelector ('#login').onclick = tryLogin

                    if (username && password) {
                        tryLogin ()
                    }
                })
            }

            function logout () {
                localStorage.setItem ('username', '')
                localStorage.setItem ('password', '')
                window.location.reload ()
            }

            function getComment (id) {
                return apiRequest ('GET', 'sharing/comments/image/?ids=' + id)
            }

            function commentExists (id) {
                return getComment (id).then (
                            function () { return true },
                            function (status) { return (status === 403) ? true : false })
            }

            function findLastComment (from, to) {

                if ((to - from) < 2) {

                    return Promise.resolve (to)

                } else {

                    var median = (from + ((to - from) / 2)) | 0

                    console.info ('range to search:', to - from, 'from:', from, 'median:', median)

                    return commentExists (median).then (function (yes) {

                        return yes ? findLastComment (median + 1, to) : findLastComment (from, median - 1)
                    })
                }
            }

            function toArray (x) {
                return [].slice.call (x, 0)
            }

            function drawComment (data) {

                contentEl.removeAttribute ('loading')

                var cmt = document.createElement ('COMMENT')
                var img = document.createElement ('IMG')

                img.src = data.url
                img.width = data.width
                img.height = data.height

                cmt.width = data.width
                cmt.height = data.height
                cmt.appendChild (img)

                cmt.style.marginLeft = (-data.width/2) | 0 + 'px'

                contentEl.insertBefore (cmt, contentEl.childNodes[0])

                var numNodes = contentEl.childNodes.length
                var top = 0
                var scale = 1
                var opacity = 1

                toArray (contentEl.childNodes).forEach (function (cmt, i) {

                    console.log (cmt)

                    var img = cmt.childNodes[0]

                    if (i > 15) {

                        contentEl.removeChild (cmt)
                        
                    } else {

                        cmt.style.zIndex = (numNodes - i)
                        cmt.style.transformOrigin = 'center top'
                        cmt.style.transform = 'translateY(' + top + 'px) scale(' + scale + ')'

                        img.style.opacity = opacity

                        top += (cmt.height - 55) * scale

                        scale = scale * 0.9
                        opacity = opacity * 0.75
                    }
                })
            }

            function fetchCommentsFrom (id) {

                getComment (id).then (function (data) {

                    drawComment (data)
                    fetchCommentsFrom (id + 1)

                }, function (e) {

                    if (e === 403) {
                        fetchCommentsFrom (id + 1)
                    } else {
                        setTimeout (fetchCommentsFrom.bind (null, id), 1100)
                    }
                })
            }

            var searchFrom = (server === 'dirty') ? 18618817 : 47672751
            var searchLength = 1000000

            penetrate ().then (function () {
                
                fetchCommentsFrom (47672447)
                //findLastComment (searchFrom, searchFrom + searchLength).then (fetchCommentsFrom)
            })

        </script>

	</body>
</html>